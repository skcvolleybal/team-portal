on:
  workflow_dispatch:
  push: 
    branches: 
      - dev
name: ğŸš€ Deploy Team-Portal to test
jobs:
  whitelist-IP: 
    name: whitelist runner IP
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ” Show Github Runner IP
      if: always()
      run: curl https://api.ipify.org
    - name: âš ï¸ You now have 30 seconds to add the Github Runner IP to Antagonist SSH key!
      run: |
        echo "For the IP: see previous step ('Show Github Runner IP'). Then, go to https://skcvolleybal.nl:2223/user/plugins/ssh and add the IP to 'Github Runner Key Antagonist."
        sleep 30s
      shell: bash
      # Continue
  get-dependencies-and-build:
    name: ğŸ‰ Deploy
    runs-on: ubuntu-latest
    steps: 
      - name: ğŸšš Get latest code
        uses: actions/checkout@v2
      - uses: actions/setup-node@master
      - name: ğŸ—ï¸ Installing NPM dependencies
        run: npm i -f
      - name: ğŸ”¨ Building Angular
        run: npm run build
      - name: ğŸ—ï¸ Installing PHP dependencies
        run: |
          composer update --ignore-platform-reqs --working-dir=php
          composer dumpautoload --working-dir=php
      - name: rsync deployments
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avzr --delete
          path: ./  
          remote_path: public_html/test/public_html/team-portal/
          remote_host: ${{ secrets.REMOTE_HOST }}
          remote_user: ${{ secrets.REMOTE_USER }}
          remote_key: ${{ secrets.PRIVATE_KEY }}
  deploy-via-rsync:
    name: ğŸ‰ Deploy 
    needs: [whitelist-IP, get-dependencies-and-build]
    runs-on: ubuntu-latest
      - name: rsync deployments
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avzr --delete
          path: ./  
          remote_path: public_html/test/public_html/team-portal/
          remote_host: ${{ secrets.REMOTE_HOST }}
          remote_user: ${{ secrets.REMOTE_USER }}
          remote_key: ${{ secrets.PRIVATE_KEY }}